<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºåœ°å€ç©ºæŠ•é¢æ¿ï¼ˆè‡ªå®šä¹‰é‡‘é¢èŒƒå›´+5ä½å°æ•°ï¼‰</title>
    <!-- Bootstrap æ ·å¼ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        /* é€šç”¨æ ·å¼ï¼ˆä¸åŸæœ‰é¢æ¿ä¿æŒä¸€è‡´ï¼‰ */
        body {
            background-color: #f5f7fa;
            padding-bottom: 50px;
        }
        .container {
            max-width: 1200px;
        }
        .header-bar {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .contract-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        .contract-card h4 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            font-weight: 600;
            color: #34495e;
        }
        .btn-custom {
            background-color: #3498db;
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .btn-custom:hover {
            background-color: #2980b9;
            color: #fff;
        }
        .btn-custom:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-read {
            background-color: #2ecc71;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin-left: 10px;
            transition: all 0.3s;
        }
        .btn-read:hover {
            background-color: #27ae60;
            color: #fff;
        }
        .btn-unlock {
            font-size: 0.8em;
            color: #999;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn-unlock:hover {
            color: #3498db;
        }
        /* çŠ¶æ€æç¤º */
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            display: none;
        }
        .status.loading {
            display: block;
            background-color: #f8f9fa;
            color: #0d6efd;
        }
        .status.success {
            display: block;
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            display: block;
            background-color: #f8d7da;
            color: #721c24;
        }
        /* æŠ˜å é¢æ¿ */
        .collapse-btn {
            background: none;
            border: none;
            color: #3498db;
            font-size: 0.9em;
            cursor: pointer;
        }
        .collapse-content {
            margin-top: 15px;
        }
        /* åœ°å€/æ•°å€¼æ ¡éªŒ */
        .is-invalid {
            border-color: #dc3545 !important;
        }
        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 5px;
        }
        /* åªè¯»æ ·å¼ */
        .addr-input[readonly], .form-control[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        /* å¼€å…³æ ·å¼ä¼˜åŒ– */
        .form-switch {
            padding-left: 2.5rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- å¤´éƒ¨ï¼šé’±åŒ…è¿æ¥ + åˆçº¦åœ°å€é…ç½® -->
        <div class="header-bar">
            <div class="row align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h3>éšæœºåœ°å€ç©ºæŠ•ç®¡ç†é¢æ¿</h3>
                </div>
                <div class="col-md-8">
                    <!-- é’±åŒ…è¿æ¥ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button id="connectWallet" class="btn-custom w-100">è¿æ¥é’±åŒ…</button>
                            <div id="walletStatus" class="mt-2 text-muted">æœªè¿æ¥é’±åŒ…</div>
                        </div>
                        <div class="col-md-6">
                            <select id="chainSelector" class="form-control">
                                <option value="56">BSC ä¸»ç½‘ (56)</option>
                                <option value="97">BSC æµ‹è¯•ç½‘ (97)</option>
                                <option value="1">ä»¥å¤ªåŠä¸»ç½‘ (1)</option>
                                <option value="5">ä»¥å¤ªåŠæµ‹è¯•ç½‘ Goerli (5)</option>
                            </select>
                        </div>
                    </div>

                    <!-- åˆçº¦åœ°å€é…ç½®ï¼ˆé¢„å…ˆå¡«å……ä½ çš„åˆçº¦åœ°å€ï¼‰ -->
                    <div class="row">
                        <div class="col-md-5 mb-2 mb-md-0">
                            <label class="form-label">ç©ºæŠ•åˆçº¦åœ°å€
                                <span class="btn-unlock" onclick="unlockInput('airdropContractAddr')">ğŸ”“ è§£é”</span>
                            </label>
                            <input type="text" id="airdropContractAddr" class="form-control addr-input" 
                                value="0xc6D48C72113974785Bfe06182C421CCF8a0EA3d0" readonly placeholder="0x...">
                        </div>
                        <div class="col-md-7">
                            <label class="form-label">Token åˆçº¦åœ°å€
                                <span class="btn-unlock" onclick="unlockInput('tokenContractAddr')">ğŸ”“ è§£é”</span>
                            </label>
                            <input type="text" id="tokenContractAddr" class="form-control addr-input" 
                                value="0xf2aa7906b5b4bda32240453bf052e8cf50be9221" readonly placeholder="0x...">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½1ï¼šå‘ç©ºæŠ•åˆçº¦è½¬è´¦Tokenï¼ˆç©ºæŠ•å‰ç½®å‡†å¤‡ï¼‰ -->
        <div class="contract-card">
            <div class="d-flex justify-content-between align-items-center">
                <h4>æ­¥éª¤1ï¼šå‘ç©ºæŠ•åˆçº¦è½¬å…¥Token</h4>
                <button class="collapse-btn" onclick="toggleCollapse('tokenTransferCollapse')">æ”¶èµ· â–²</button>
            </div>
            <div id="tokenTransferCollapse" class="collapse-content">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">è½¬è´¦Tokenæ•°é‡ï¼ˆä¸å«å°æ•°ï¼Œè‡ªåŠ¨é€‚é…18ä½å°æ•°ï¼Œå¯¹åº”åˆçº¦çš„X.00000ï¼‰</label>
                                <input type="number" id="transferTokenAmount" class="form-control" placeholder="è¯·è¾“å…¥è¦è½¬å…¥çš„Tokenæ•°é‡" min="1" step="1">
                            </div>
                            <div class="col-md-3">
                                <button onclick="transferTokenToAirdropContract()" class="btn-custom w-100">æ‰§è¡Œè½¬è´¦</button>
                            </div>
                            <div class="col-md-3">
                                <button onclick="readAirdropContractTokenBalance()" class="btn-read w-100">æŸ¥è¯¢ç©ºæŠ•åˆçº¦ä½™é¢</button>
                            </div>
                        </div>
                        <div id="tokenTransferStatusMsg" class="status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½2ï¼šæ‰§è¡Œæ‰¹é‡éšæœºç©ºæŠ•ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œé€‚é…ä¸‰å‚æ•°ï¼‰ -->
        <div class="contract-card">
            <div class="d-flex justify-content-between align-items-center">
                <h4>æ­¥éª¤2ï¼šæ‰§è¡Œæ‰¹é‡éšæœºç©ºæŠ•ï¼ˆè‡ªå®šä¹‰é‡‘é¢èŒƒå›´ï¼‰</h4>
                <button class="collapse-btn" onclick="toggleCollapse('batchAirdropCollapse')">æ”¶èµ· â–²</button>
            </div>
            <div id="batchAirdropCollapse" class="collapse-content">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>æç¤ºï¼š</strong>
                            1.  é‡‘é¢ä¸‹é™/ä¸Šé™ä¸ºåŸºå‡†å€¼ï¼ˆå¦‚1=1.00000ï¼Œ10=10.00000ï¼‰ï¼Œæ”¯æŒ5ä½å°æ•°éšæœºç”Ÿæˆï¼ˆå¦‚1.43921ï¼‰ã€‚<br>
                            2.  ç©ºæŠ•æ¬¡æ•°ä¸èƒ½è¶…è¿‡ã€Œåˆçº¦ä½™é¢ Ã· é‡‘é¢ä¸‹é™ã€ï¼Œæ¯ä¸ªåœ°å€è‡³å°‘ç©ºæŠ•ä¸‹é™å¯¹åº”çš„Tokenæ•°é‡ã€‚<br>
                            3.  ç”Ÿæˆçš„åœ°å€ä¸ºæ— ä¸»é»‘æ´åœ°å€ï¼ŒTokenè½¬å…¥åæ— æ³•æå–ï¼
                        </div>
                        <div class="row align-items-end mb-3">
                            <div class="col-md-4">
                                <label class="form-label">é‡‘é¢ä¸‹é™ï¼ˆåŸºå‡†å€¼ï¼Œâ‰¥1ï¼‰</label>
                                <input type="number" id="airdropMinAmount" class="form-control" placeholder="å¦‚1ï¼ˆå¯¹åº”1.00000ï¼‰" min="1" step="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">é‡‘é¢ä¸Šé™ï¼ˆåŸºå‡†å€¼ï¼Œâ‰¥ä¸‹é™ï¼‰</label>
                                <input type="number" id="airdropMaxAmount" class="form-control" placeholder="å¦‚10ï¼ˆå¯¹åº”10.00000ï¼‰" min="1" step="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ç©ºæŠ•æ¬¡æ•°ï¼ˆç”Ÿæˆéšæœºåœ°å€æ•°é‡ï¼‰</label>
                                <input type="number" id="airdropCount" class="form-control" placeholder="å¦‚100" min="1" step="1">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button onclick="executeBatchRandomAirdrop()" class="btn-custom w-100">æ‰§è¡Œæ‰¹é‡ç©ºæŠ•</button>
                            </div>
                        </div>
                        <div id="batchAirdropStatusMsg" class="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒäº¤äº’è„šæœ¬ -->
    <script>
        // å…¨å±€å˜é‡
        let provider, signer, walletAddress;

        // ========== åˆçº¦ABIå®šä¹‰ï¼ˆæ›´æ–°ç©ºæŠ•å‡½æ•°ä¸ºä¸‰å‚æ•°ï¼‰ ==========
        // 1. ç©ºæŠ•åˆçº¦ABIï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œé€‚é…ä¸‰å‚æ•°executeBatchRandomAirdropï¼‰
        const airdropContractABI = [
            "function executeBatchRandomAirdrop(uint256 _minAmount, uint256 _maxAmount, uint256 _airdropCount) external",
            "function getContractTokenBalance() external view returns (uint256)",
            "function tokenContract() external view returns (address)",
            "function formatFiveDecimals(uint256 _amountFiveDec) external pure returns (string memory)"
        ];

        // 2. ERC20 Tokenåˆçº¦ABIï¼ˆè½¬è´¦+å°æ•°ä½æŸ¥è¯¢ï¼‰
        const erc20TokenABI = [
            "function transfer(address to, uint256 amount) external returns (bool)",
            "function decimals() external view returns (uint8)",
            "function balanceOf(address account) external view returns (uint256)"
        ];

        // ========== é’±åŒ…è¿æ¥é€»è¾‘ï¼ˆä¸åŸæœ‰é¢æ¿ä¿æŒä¸€è‡´ï¼‰ ==========
        window.addEventListener('DOMContentLoaded', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        initWallet(accounts[0]);
                    }
                } catch (err) {
                    console.log('æ£€æŸ¥é’±åŒ…çŠ¶æ€å¤±è´¥:', err);
                }

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        initWallet(accounts[0]);
                    } else {
                        resetWalletStatus();
                    }
                });

                window.ethereum.on('chainChanged', (chainId) => {
                    window.location.reload();
                });
            }
        });

        async function initWallet(addr) {
            walletAddress = addr;
            provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
            await provider.send('eth_requestAccounts', []);
            signer = provider.getSigner();
            
            document.getElementById('walletStatus').textContent = `å·²è¿æ¥: ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;
            document.getElementById('walletStatus').style.color = '#198754';
            document.getElementById('connectWallet').textContent = 'åˆ‡æ¢é’±åŒ…';

            // è¿æ¥é’±åŒ…åè‡ªåŠ¨æŸ¥è¯¢ä¸€æ¬¡ç©ºæŠ•åˆçº¦ä½™é¢
            setTimeout(() => readAirdropContractTokenBalance(), 1000);
        }

        function resetWalletStatus() {
            walletAddress = null;
            provider = null;
            signer = null;
            document.getElementById('walletStatus').textContent = 'æœªè¿æ¥é’±åŒ…';
            document.getElementById('walletStatus').style.color = '#6c757d';
            document.getElementById('connectWallet').textContent = 'è¿æ¥é’±åŒ…';
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) {
                alert('è¯·å®‰è£…MetaMaské’±åŒ…ï¼ˆæˆ–å…¶ä»–EVMå…¼å®¹é’±åŒ…ï¼‰ï¼');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('æœªæˆæƒä»»ä½•è´¦æˆ·');
                }

                initWallet(accounts[0]);
            } catch (error) {
                document.getElementById('walletStatus').textContent = `è¿æ¥å¤±è´¥: ${error.message}`;
                document.getElementById('walletStatus').style.color = '#dc3545';
                console.error('é’±åŒ…è¿æ¥é”™è¯¯:', error);
            }
        });

        // åˆ‡æ¢é“¾é€»è¾‘
        document.getElementById('chainSelector').addEventListener('change', async (e) => {
            if (!window.ethereum) {
                alert('è¯·å®‰è£…MetaMaské’±åŒ…ï¼');
                return;
            }

            const chainId = e.target.value;
            const hexChainId = ethers.utils.hexValue(parseInt(chainId));

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: hexChainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    alert(`å½“å‰é’±åŒ…æœªæ·»åŠ è¯¥é“¾ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ é“¾ID ${chainId} åé‡è¯•ï¼`);
                } else {
                    alert(`åˆ‡æ¢é“¾å¤±è´¥: ${switchError.message}`);
                }
            }
        });

        // è§£é”/é”å®šè¾“å…¥æ¡†
        function unlockInput(id) {
            const input = document.getElementById(id);
            if (input.readOnly) {
                input.readOnly = false;
                input.style.backgroundColor = '#fff';
                input.style.cursor = 'text';
                const unlockBtn = input.parentElement.querySelector('.btn-unlock');
                unlockBtn.textContent = 'ğŸ”’ é”å®š';
                unlockBtn.onclick = () => lockInput(id);
            }
        }

        function lockInput(id) {
            const input = document.getElementById(id);
            input.readOnly = true;
            input.style.backgroundColor = '#f8f9fa';
            input.style.cursor = 'not-allowed';
            const unlockBtn = input.parentElement.querySelector('.btn-unlock');
            unlockBtn.textContent = 'ğŸ”“ è§£é”';
            unlockBtn.onclick = () => unlockInput(id);
        }

        // æŠ˜å /å±•å¼€é¢æ¿
        function toggleCollapse(id) {
            const content = document.getElementById(id);
            const btn = content.parentElement.querySelector('.collapse-btn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'æ”¶èµ· â–²';
            } else {
                content.style.display = 'none';
                btn.textContent = 'å±•å¼€ â–¼';
            }
        }

        // ========== åŠŸèƒ½1ï¼šå‘ç©ºæŠ•åˆçº¦è½¬è´¦Tokenï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        async function transferTokenToAirdropContract() {
            if (!provider || !signer) return alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
            
            // è·å–è¾“å…¥å‚æ•°
            const airdropContractAddr = document.getElementById('airdropContractAddr').value;
            const tokenContractAddr = document.getElementById('tokenContractAddr').value;
            const transferAmount = document.getElementById('transferTokenAmount').value;
            const statusEl = document.getElementById('tokenTransferStatusMsg');

            // å‰ç½®æ ¡éªŒ
            try {
                if (!ethers.utils.isAddress(airdropContractAddr)) throw new Error('ç©ºæŠ•åˆçº¦åœ°å€æ— æ•ˆ');
                if (!ethers.utils.isAddress(tokenContractAddr)) throw new Error('Tokenåˆçº¦åœ°å€æ— æ•ˆ');
                if (!transferAmount || transferAmount < 1) throw new Error('è¯·è¾“å…¥å¤§äº0çš„è½¬è´¦æ•°é‡');
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `å‚æ•°é”™è¯¯: ${error.message}`;
                return;
            }

            // åˆå§‹åŒ–åˆçº¦å®ä¾‹
            const tokenContract = new ethers.Contract(tokenContractAddr, erc20TokenABI, signer);

            try {
                // 1. è·å–Tokenå°æ•°ä½ï¼ˆé»˜è®¤18ä½ï¼Œå…¼å®¹è‡ªå®šä¹‰å°æ•°ä½Tokenï¼‰
                statusEl.className = 'status loading';
                statusEl.textContent = 'æ­£åœ¨è·å–Tokenå°æ•°ä½...';
                const decimals = await tokenContract.decimals();
                
                // 2. è½¬æ¢æ•°é‡ä¸ºweiå•ä½ï¼ˆERC20è½¬è´¦æœ€å°å•ä½ï¼‰
                const transferAmountWei = ethers.utils.parseUnits(transferAmount, decimals);
                
                // 3. æ‰§è¡Œè½¬è´¦äº¤æ˜“
                statusEl.textContent = 'äº¤æ˜“å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…é’±åŒ…ç¡®è®¤å¹¶ä¸Šé“¾...';
                const tx = await tokenContract.transfer(airdropContractAddr, transferAmountWei);
                
                // 4. ç­‰å¾…äº¤æ˜“ä¸Šé“¾
                await tx.wait();
                
                // 5. æ›´æ–°æˆåŠŸçŠ¶æ€
                statusEl.className = 'status success';
                statusEl.textContent = `è½¬è´¦æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${tx.hash.substring(0, 10)}...${tx.hash.substring(tx.hash.length - 6)}`;
                
                // 6. è½¬è´¦æˆåŠŸåè‡ªåŠ¨æŸ¥è¯¢ç©ºæŠ•åˆçº¦ä½™é¢
                setTimeout(() => readAirdropContractTokenBalance(), 1500);
            } catch (error) {
                // ç®€åŒ–é”™è¯¯æç¤º
                let errorMsg = error.message;
                if (errorMsg.includes('insufficient funds')) {
                    errorMsg = 'æ‰§è¡Œå¤±è´¥ï¼šä½ çš„é’±åŒ…Tokenä½™é¢ä¸è¶³';
                } else if (errorMsg.includes('user rejected')) {
                    errorMsg = 'æ‰§è¡Œå¤±è´¥ï¼šä½ å·²æ‹’ç»é’±åŒ…äº¤æ˜“è¯·æ±‚';
                } else if (errorMsg.length > 100) {
                    errorMsg = errorMsg.substring(0, 100) + '...';
                }
                
                statusEl.className = 'status error';
                statusEl.textContent = `è½¬è´¦å¤±è´¥: ${errorMsg}`;
                console.error('è½¬è´¦Tokené”™è¯¯:', error);
            }
        }

        // ========== åŠŸèƒ½2ï¼šæŸ¥è¯¢ç©ºæŠ•åˆçº¦Tokenä½™é¢ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        async function readAirdropContractTokenBalance() {
            if (!provider) return alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
            
            // è·å–è¾“å…¥å‚æ•°
            const airdropContractAddr = document.getElementById('airdropContractAddr').value;
            const tokenContractAddr = document.getElementById('tokenContractAddr').value;
            const statusEl = document.getElementById('tokenTransferStatusMsg');

            // å‰ç½®æ ¡éªŒ
            try {
                if (!ethers.utils.isAddress(airdropContractAddr)) throw new Error('ç©ºæŠ•åˆçº¦åœ°å€æ— æ•ˆ');
                if (!ethers.utils.isAddress(tokenContractAddr)) throw new Error('Tokenåˆçº¦åœ°å€æ— æ•ˆ');
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `å‚æ•°é”™è¯¯: ${error.message}`;
                return;
            }

            // åˆå§‹åŒ–åˆçº¦å®ä¾‹
            const airdropContract = new ethers.Contract(airdropContractAddr, airdropContractABI, provider);
            const tokenContract = new ethers.Contract(tokenContractAddr, erc20TokenABI, provider);

            try {
                // 1. è·å–ä½™é¢ï¼ˆweiå•ä½ï¼‰
                statusEl.className = 'status loading';
                statusEl.textContent = 'æ­£åœ¨æŸ¥è¯¢ç©ºæŠ•åˆçº¦Tokenä½™é¢...';
                const balanceWei = await airdropContract.getContractTokenBalance();
                const decimals = await tokenContract.decimals();
                
                // 2. è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼ˆå»é™¤å°æ•°ä½ï¼Œä¾¿äºç”¨æˆ·ç†è§£ï¼‰
                const balanceReadable = ethers.utils.formatUnits(balanceWei, decimals);
                const balanceInteger = Math.floor(Number(balanceReadable));
                
                // 3. æ›´æ–°æˆåŠŸçŠ¶æ€
                statusEl.className = 'status success';
                statusEl.textContent = `æŸ¥è¯¢æˆåŠŸï¼ç©ºæŠ•åˆçº¦å½“å‰Tokenä½™é¢ï¼š${balanceInteger} ä¸ªï¼ˆç²¾ç¡®å€¼ï¼š${balanceReadable}ï¼‰`;
            } catch (error) {
                // ç®€åŒ–é”™è¯¯æç¤º
                let errorMsg = error.message;
                if (errorMsg.length > 100) {
                    errorMsg = errorMsg.substring(0, 100) + '...';
                }
                
                statusEl.className = 'status error';
                statusEl.textContent = `æŸ¥è¯¢å¤±è´¥: ${errorMsg}`;
                console.error('æŸ¥è¯¢ä½™é¢é”™è¯¯:', error);
            }
        }

        // ========== åŠŸèƒ½3ï¼šæ‰§è¡Œæ‰¹é‡éšæœºç©ºæŠ•ï¼ˆä¿®æ”¹ä¸ºä¸‰å‚æ•°ï¼‰ ==========
        async function executeBatchRandomAirdrop() {
            if (!provider || !signer) return alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
            
            // è·å–è¾“å…¥å‚æ•°ï¼ˆä¸‰å‚æ•°ï¼šä¸‹é™ã€ä¸Šé™ã€ç©ºæŠ•æ¬¡æ•°ï¼‰
            const airdropContractAddr = document.getElementById('airdropContractAddr').value;
            const minAmount = document.getElementById('airdropMinAmount').value;
            const maxAmount = document.getElementById('airdropMaxAmount').value;
            const airdropCount = document.getElementById('airdropCount').value;
            const statusEl = document.getElementById('batchAirdropStatusMsg');

            // ========== å‰ç½®å‚æ•°æ ¡éªŒï¼ˆæ–°å¢ä¸‰å‚æ•°é€»è¾‘ï¼‰ ==========
            try {
                if (!ethers.utils.isAddress(airdropContractAddr)) throw new Error('ç©ºæŠ•åˆçº¦åœ°å€æ— æ•ˆ');
                if (!minAmount || minAmount < 1) throw new Error('é‡‘é¢ä¸‹é™å¿…é¡»å¤§äº0ï¼ˆå¦‚1å¯¹åº”1.00000ï¼‰');
                if (!maxAmount || maxAmount < 1) throw new Error('é‡‘é¢ä¸Šé™å¿…é¡»å¤§äº0ï¼ˆå¦‚10å¯¹åº”10.00000ï¼‰');
                if (!airdropCount || airdropCount < 1) throw new Error('ç©ºæŠ•æ¬¡æ•°å¿…é¡»å¤§äº0');
                if (Number(maxAmount) < Number(minAmount)) throw new Error('é‡‘é¢ä¸Šé™ä¸èƒ½å°äºé‡‘é¢ä¸‹é™');
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `å‚æ•°é”™è¯¯: ${error.message}`;
                return;
            }

            // åˆå§‹åŒ–åˆçº¦å®ä¾‹
            const airdropContract = new ethers.Contract(airdropContractAddr, airdropContractABI, signer);
            const tokenContractAddr = document.getElementById('tokenContractAddr').value;
            const tokenContract = new ethers.Contract(tokenContractAddr, erc20TokenABI, provider);

            try {
                // 1. å…ˆæ ¡éªŒç©ºæŠ•åˆçº¦ä½™é¢æ˜¯å¦è¶³å¤Ÿï¼ˆåŸºäºé‡‘é¢ä¸‹é™ï¼‰
                statusEl.className = 'status loading';
                statusEl.textContent = 'æ­£åœ¨æ ¡éªŒç©ºæŠ•åˆçº¦Tokenä½™é¢...';
                
                // è·å–åˆçº¦ä½™é¢ï¼ˆweiå•ä½ï¼‰å’ŒTokenå°æ•°ä½
                const balanceWei = await airdropContract.getContractTokenBalance();
                const decimals = await tokenContract.decimals();
                
                // è®¡ç®—æœ€å°æ€»éœ€æ±‚é‡‘é¢ï¼ˆç©ºæŠ•æ¬¡æ•° Ã— é‡‘é¢ä¸‹é™ï¼‰
                const minTotalAmount = Number(airdropCount) * Number(minAmount);
                const minTotalAmountWei = ethers.utils.parseUnits(minTotalAmount.toString(), decimals);
                
                if (balanceWei.lt(minTotalAmountWei)) {
                    throw new Error(`ç©ºæŠ•åˆçº¦ä½™é¢ä¸è¶³ï¼ˆå½“å‰ä½™é¢ä¸è¶³ä»¥æ”¯æ’‘ ${airdropCount} æ¬¡ç©ºæŠ•ï¼Œæ¯æ¬¡æœ€å° ${minAmount}.00000 ä¸ªTokenï¼‰`);
                }

                // 2. æ‰§è¡Œæ‰¹é‡ç©ºæŠ•äº¤æ˜“ï¼ˆä¼ å…¥ä¸‰å‚æ•°ï¼Œç”¨BigNumberåŒ…è£…é˜²æ­¢æº¢å‡ºï¼‰
                statusEl.textContent = 'ç©ºæŠ•äº¤æ˜“å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…é’±åŒ…ç¡®è®¤å¹¶ä¸Šé“¾...';
                const tx = await airdropContract.executeBatchRandomAirdrop(
                    ethers.BigNumber.from(minAmount),
                    ethers.BigNumber.from(maxAmount),
                    ethers.BigNumber.from(airdropCount)
                );
                
                // 3. ç­‰å¾…äº¤æ˜“ä¸Šé“¾
                await tx.wait();
                
                // 4. æ›´æ–°æˆåŠŸçŠ¶æ€
                statusEl.className = 'status success';
                statusEl.textContent = `ç©ºæŠ•æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${tx.hash.substring(0, 10)}...${tx.hash.substring(tx.hash.length - 6)}ï¼Œå…±ç”Ÿæˆ ${airdropCount} ä¸ªéšæœºåœ°å€ï¼Œé‡‘é¢èŒƒå›´ ${minAmount}.00000 ~ ${maxAmount}.00000`;
                
                // 5. ç©ºæŠ•æˆåŠŸåè‡ªåŠ¨æŸ¥è¯¢æœ€æ–°ä½™é¢
                setTimeout(() => readAirdropContractTokenBalance(), 1500);
            } catch (error) {
                // ç®€åŒ–é”™è¯¯æç¤º
                let errorMsg = error.message;
                if (errorMsg.includes('user rejected')) {
                    errorMsg = 'æ‰§è¡Œå¤±è´¥ï¼šä½ å·²æ‹’ç»é’±åŒ…äº¤æ˜“è¯·æ±‚';
                } else if (errorMsg.includes('Insufficient token balance')) {
                    errorMsg = 'æ‰§è¡Œå¤±è´¥ï¼šç©ºæŠ•åˆçº¦Tokenä½™é¢ä¸è¶³';
                } else if (errorMsg.length > 150) {
                    errorMsg = errorMsg.substring(0, 150) + '...';
                }
                
                statusEl.className = 'status error';
                statusEl.textContent = `ç©ºæŠ•å¤±è´¥: ${errorMsg}`;
                console.error('æ‰§è¡Œç©ºæŠ•é”™è¯¯:', error);
            }
        }

        // é¡µé¢åˆå§‹åŒ–ï¼šé»˜è®¤å±•å¼€æ‰€æœ‰é¢æ¿
        window.onload = function() {
            document.querySelectorAll('.collapse-content').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.textContent = 'æ”¶èµ· â–²';
            });
        };
    </script>
</body>
</html>
